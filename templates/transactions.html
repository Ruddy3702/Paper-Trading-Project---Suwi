{% extends "base.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}
<div class="container py-3 my-3">
  <h2 class="pb-3">Transaction History</h2>

  <div class="mb-2">
    <h6 class="mb-1">Available Funds: â‚¹ {{ current_user.balance }}</h6>

    <h6>
      Total Realised P&L:
      <span class="
        {% if total_pnl > 0 %}
          text-success
        {% elif total_pnl < 0 %}
          text-danger
        {% else %}
          text-secondary
        {% endif %}
      ">
        â‚¹ {{ "%.2f"|format(total_pnl) }}
      </span>
    </h6>
  </div>

  <!-- ðŸ” REALTIME SEARCH -->
  <div class="mb-3">
    <input type="text"
           id="txSearch"
           class="form-control form-control-sm"
           placeholder="Search by symbol, action, remarks, or txn id">
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-striped align-middle table-sm">
      <thead class="table-dark sticky-top">
        <tr>
          <th scope="col">Date</th>
          <th scope="col">Symbol</th>
          <th scope="col">Action</th>
          <th scope="col">Qty</th>
          <th scope="col">Price</th>
          <th scope="col" class="d-none d-md-table-cell">Current</th>
          <th scope="col">Value</th>
          <th scope="col">P&L</th>
          <th scope="col" class="d-none d-lg-table-cell">Txn ID</th>
          <th scope="col" class="d-none d-lg-table-cell">Remarks</th>
        </tr>
      </thead>

      <tbody>
        {% for tx in data %}
        <tr data-search="
            {{ tx['symbol']|lower }}
            {{ tx['type']|lower }}
            {{ tx['txn_id']|string|lower }}
            {{ tx['remarks']|default('', true)|lower }}
        ">

          <!-- DATE -->
          <td class="text-center">
            {{ tx["timestamp"].strftime("%d/%m/%Y") }}
          </td>

          <!-- SYMBOL -->
          <td class="text-center">
            <a href="{{ url_for('stock_info', symbol=tx['symbol']) }}">
              {{ tx["symbol"] }}
            </a>
          </td>

          <!-- ACTION -->
          <td class="text-center fw-semibold">
            {{ tx["type"] }}
          </td>

          <!-- QTY -->
          <td class="text-center">
            {{ "%.2f"|format(tx["quantity"]) }}
          </td>

          <!-- EXEC PRICE -->
          <td class="text-center">
            {{ tx["execution_price"] }}
          </td>

          <!-- CURRENT PRICE -->
          <td class="text-center d-none d-md-table-cell">
            {{ tx["current_price"] if tx["current_price"] is not none else "-" }}
          </td>

          <!-- TOTAL VALUE -->
          <td class="text-center">
            {{ "%.2f"|format(tx["total_value"]) }}
          </td>

          <!-- PNL -->
          <td class="text-center
            {% if tx['pnl'] > 0 %}text-success
            {% elif tx['pnl'] < 0 %}text-danger
            {% else %}text-secondary
            {% endif %}
          ">
            {{ "%.2f"|format(tx['pnl']) if tx['pnl'] else "0.00" }}
          </td>

          <!-- TXN ID -->
          <td class="text-center d-none d-lg-table-cell">
            {{ tx["txn_id"] }}
          </td>

          <!-- REMARKS -->
          <td class="text-center d-none d-lg-table-cell">
            {{ tx["remarks"] }}
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
    <nav class="mt-3">
  <ul class="pagination justify-content-center">

    {% if has_prev %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page - 1 }}">Previous</a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">Previous</span>
    </li>
    {% endif %}

    <li class="page-item active">
      <span class="page-link">Page {{ page }}</span>
    </li>

    {% if has_next %}
    <li class="page-item">
      <a class="page-link" href="?page={{ page + 1 }}">Next</a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">Next</span>
    </li>
    {% endif %}

  </ul>
</nav>

  </div>
</div>

<script>
  const txSearch = document.getElementById("txSearch");
  const txRows = document.querySelectorAll("tbody tr");

  txSearch.addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();

    txRows.forEach(row => {
      const text = row.dataset.search;
      row.style.display = text.includes(query) ? "" : "none";
    });
  });
</script>

{% endblock %}
