{% extends "base.html" %}
{% block title %}Stock Data{% endblock %}

{% block content %}
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<!-- STOCK SUMMARY -->
<div class="container py-4 px-3 px-md-5">
  <div class="p-4 p-md-5 mb-4 bg-body-tertiary rounded-3">
    <div class="container-fluid py-3 py-md-5">

      <h1 class="display-6 display-md-5 fw-bold mb-1">
        {{ stock['v']['name'] }}
      </h1>
      <h5 class="text-muted mb-3">
        {{ stock['v']['symbol'] }}
      </h5>

      <p class="fs-6 fs-md-5">Data at a glance</p>

      <!-- DATA TABLE -->
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle table-sm">
          <thead class="table-dark sticky-top">
            <tr>
              <th>Symbol</th>
              <th>Price(₹)</th>
              <th>Change(₹)</th>
              <th>Change %</th>
              <th class="d-none d-sm-table-cell">From Open (%)</th>
              <th class="d-none d-md-table-cell">Open(₹)</th>
              <th class="d-none d-md-table-cell">Close(₹)</th>
              <th class="d-none d-lg-table-cell">High/Low(₹)</th>
              <th class="d-none d-lg-table-cell">Volume</th>
              <th class="d-none d-xl-table-cell">Trend</th>
            </tr>
          </thead>

          <tbody>
            {% set v = stock['v'] %}
            <tr>
              <td class="text-center fw-semibold">{{ stock["n"] }}</td>

              <td class="text-center fw-semibold">
                {{ "%.2f"|format(v["lp"]) if v["lp"] else "-" }}
              </td>

              <td class="text-center {% if v['ch'] > 0 %}text-success{% elif v['ch'] < 0 %}text-danger{% else %}text-secondary{% endif %}">
                {{ "%.2f"|format(v["ch"]) if v["ch"] else "0.00" }}
              </td>

              <td class="text-center {% if v['chp'] > 0 %}text-success{% elif v['chp'] < 0 %}text-danger{% else %}text-secondary{% endif %}">
                {{ "%.2f"|format(v["chp"]) if v["chp"] else "0.00" }}%
              </td>

              <td class="text-center d-none d-sm-table-cell">
                {{ "%.2f"|format(v["from_open_percent"]) if v["from_open_percent"] else "-" }}%
              </td>

              <td class="text-center d-none d-md-table-cell">
                {{ "%.2f"|format(v["open_price"]) if v["open_price"] else "-" }}
              </td>

              <td class="text-center d-none d-md-table-cell">
                {{ "%.2f"|format(v["prev_close_price"]) if v["prev_close_price"] else "-" }}
              </td>

              <td class="text-center d-none d-lg-table-cell">
                {{ "%.2f"|format(v["high_price"]) if v["high_price"] else "-" }}/
                {{ "%.2f"|format(v["low_price"]) if v["low_price"] else "-" }}
              </td>

              <td class="text-center d-none d-lg-table-cell">
                {{ "{:,}".format(v["volume"]) if v["volume"] else "-" }}
              </td>

              <td class="text-center d-none d-xl-table-cell">
                {{ v["trend"] if v["trend"] else "-" }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- BUY / SELL -->
      <div class="d-flex flex-column flex-sm-row gap-3 mt-3">
        <a href="{{ url_for('buy', symbol=stock['v']['symbol']) }}"
           class="btn btn-success btn-lg w-100 w-sm-auto">
          Buy
        </a>
        <a href="{{ url_for('sell', symbol=stock['v']['symbol']) }}"
           class="btn btn-danger btn-lg w-100 w-sm-auto">
          Sell
        </a>
      </div>

    </div>
  </div>
</div>

<!-- RANGE BUTTONS -->
<div class="container my-3">
  <div class="d-flex justify-content-center flex-wrap gap-2">
    <button class="btn btn-outline-secondary" onclick="loadRange('5D')">5D</button>
    <button class="btn btn-outline-secondary" onclick="loadRange('1M')">1M</button>
    <button class="btn btn-outline-secondary" onclick="loadRange('3M')">3M</button>
    <button class="btn btn-outline-secondary" onclick="loadRange('6M')">6M</button>
    <button class="btn btn-outline-secondary" onclick="loadRange('1Y')">1Y</button>
    <button class="btn btn-outline-secondary" onclick="loadRange('5Y')">5Y</button>
  </div>
</div>

<!-- CHART -->
<div class="container my-4">
  <div id="chart" style="width:100%; height:360px;"></div>
</div>

<!-- JS (unchanged logic) -->
<script>
let chart;
let candleSeries;
let loading = false;

document.addEventListener("DOMContentLoaded", function () {

    const rawCandles = {{ candles | tojson }};
    const container = document.getElementById("chart");

    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: window.innerWidth < 768 ? 280 : 420,
        layout: {
            background: { color: "#ffffff" },
            textColor: "#000000"
        },
        grid: {
            vertLines: { visible: false },
            horzLines: { visible: false }
        }
    });

    candleSeries = chart.addSeries(
        LightweightCharts.CandlestickSeries
    );

    if (rawCandles && rawCandles.length) {
        candleSeries.setData(
            rawCandles.map(c => ({
                time: c[0],
                open: c[1],
                high: c[2],
                low: c[3],
                close: c[4]
            }))
        );
        chart.timeScale().fitContent();
    }

    window.addEventListener("resize", () => {
        chart.applyOptions({
            width: container.clientWidth,
            height: window.innerWidth < 768 ? 280 : 420
        });
    });
});

async function loadRange(range) {
    if (loading) return;
    loading = true;

    const symbol = "{{ stock['v']['symbol'] }}";

    try {
        const res = await fetch(`/candles/${symbol}?range=${range}`);
        const json = await res.json();

        const candles = json.candles || [];

        if (!candles.length) {
            console.warn("No candle data for range:", range);
            return;
        }

        candleSeries.setData(
            candles.map(c => ({
                time: c[0],
                open: c[1],
                high: c[2],
                low: c[3],
                close: c[4]
            }))
        );

        chart.timeScale().fitContent();

    } catch (err) {
        console.error("Chart update failed:", err);
    } finally {
        loading = false;
    }
}
</script>

<!-- NEWS -->
{% if news_data %}
<div class="container my-4">
  <h4 class="mb-3">News for {{ stock['v']['name'] }}</h4>

  <div class="list-group">
    {% for news in news_data %}
    <a href="{{ news['link'] }}" target="_blank"
       class="list-group-item list-group-item-action py-3">
      <h6 class="mb-1">{{ news['title'] }}</h6>
      <p class="mb-0 opacity-75 small">{{ news['snippet'] }}</p>
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}

{% endblock %}
