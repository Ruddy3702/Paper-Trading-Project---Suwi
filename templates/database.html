{% extends "base.html" %}
{% block title %}All Stocks{% endblock %}

{% block content %}
<div class="container-fluid container-md py-3 my-3">

  <h2 class="pb-3 text-center text-md-start">
    Stocks
    {% if status %}ðŸŸ¢{% else %}ðŸ”´{% endif %}
  </h2>

  <form method="get" action="{{ url_for('database') }}" class="mb-3">
    <input
      type="text"
      name="q"
      value="{{ query }}"
      class="form-control form-control-sm"
      placeholder="Search NSE stocks by name or symbol (e.g. INFY, RELIANCE)"
    >
  </form>

  <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 mb-3">
    <form method="get" action="{{ url_for('database') }}" class="d-flex flex-wrap gap-2">

      <input type="hidden" name="q" value="{{ query }}">

      <label class="form-label fw-semibold mb-0">Sort by:</label>

      <select name="sort_by"
              class="form-select form-select-sm w-auto"
              onchange="this.form.submit()">
        <option value="">Select</option>
        <option value="volume" {% if sort_by == 'volume' %}selected{% endif %}>Volume</option>
        <option value="chp" {% if sort_by == 'chp' %}selected{% endif %}>Change %</option>
        <option value="lp" {% if sort_by == 'lp' %}selected{% endif %}>Price</option>
        <option value="trend" {% if sort_by == 'trend' %}selected{% endif %}>Trend</option>
      </select>

      <input type="hidden" name="order" value="{{ order }}">
    </form>

    {% if sort_by %}
      <a class="btn btn-outline-secondary btn-sm"
         href="?q={{ query }}&sort_by={{ sort_by }}&order={{ 'asc' if order=='desc' else 'desc' }}">
        {% if order == 'desc' %}â–²{% else %}â–¼{% endif %}
      </a>
    {% endif %}
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-striped align-middle table-sm">
      <thead class="table-dark sticky-top">
        <tr>
          <th>Symbol</th>
          <th>Name</th>
          <th>Price â‚¹</th>
          <th>Change â‚¹</th>
          <th>Change %</th>
          <th class="d-none d-sm-table-cell">From Open %</th>
          <th class="d-none d-md-table-cell">Open â‚¹</th>
          <th class="d-none d-md-table-cell">Prev Close â‚¹</th>
          <th class="d-none d-lg-table-cell">High / Low â‚¹</th>
          <th class="d-none d-lg-table-cell">Volume</th>
          <th class="d-none d-xl-table-cell">Trend</th>
          <th class="text-center">Action</th>
        </tr>
      </thead>

      <tbody>
      {% for stock in all_stocks %}
        {% set v = stock["v"] %}
        <tr>
          <td class="text-center">
            <a href="{{ url_for('stock_info', symbol=v['symbol']) }}">
              {{ v['symbol'][4:].split('-EQ')[0] }}
            </a>
          </td>

          <td class="text-center small">{{ v["name"] }}</td>

          <td class="text-center fw-semibold">
            {{ "%.2f"|format(v["lp"]) if v["lp"] is not none else "-" }}
          </td>

          <td class="text-center {% if v['ch'] > 0 %}text-success{% elif v['ch'] < 0 %}text-danger{% else %}text-secondary{% endif %}">
            {{ "%.2f"|format(v["ch"]) if v["ch"] is not none else "-" }}
          </td>

          <td class="text-center {% if v['chp'] > 0 %}text-success{% elif v['chp'] < 0 %}text-danger{% else %}text-secondary{% endif %}">
            {{ "%.2f"|format(v["chp"]) if v["chp"] is not none else "-" }}%
          </td>

          <td class="text-center d-none d-sm-table-cell">
            {{ "%.2f"|format(v["from_open_percent"]) if v["from_open_percent"] is not none else "-" }}%
          </td>

          <td class="text-center d-none d-md-table-cell">
            {{ "%.2f"|format(v["open_price"]) if v["open_price"] is not none else "-" }}
          </td>

          <td class="text-center d-none d-md-table-cell">
            {{ "%.2f"|format(v["prev_close_price"]) if v["prev_close_price"] is not none else "-" }}
          </td>

          <td class="text-center d-none d-lg-table-cell">
            {{ "%.2f"|format(v["high_price"]) if v["high_price"] is not none else "-" }} /
            {{ "%.2f"|format(v["low_price"]) if v["low_price"] is not none else "-" }}
          </td>

          <td class="text-center d-none d-lg-table-cell">
            {{ "{:,}".format(v["volume"]) if v["volume"] else "-" }}
          </td>

          <td class="text-center d-none d-xl-table-cell">
            {{ v["trend"] }}
          </td>

          <td>
            <div class="d-flex justify-content-center gap-1">
              <a class="btn btn-success btn-sm" href="{{ url_for('buy', symbol=v['symbol']) }}">Buy</a>
              <a class="btn btn-danger btn-sm" href="{{ url_for('sell', symbol=v['symbol']) }}">Sell</a>
            </div>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if has_prev %}
        <li class="page-item">
          <a class="page-link"
             href="?q={{ query }}&page={{ page-1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&order={{ order }}">
            Previous
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      <li class="page-item active"><span class="page-link">Page {{ page }}</span></li>

      {% if has_next %}
        <li class="page-item">
          <a class="page-link"
             href="?q={{ query }}&page={{ page+1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&order={{ order }}">
            Next
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>

</div>
{% endblock %}
